<!doctype html><html lang=zh-cn>
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<meta charset=utf-8>
<meta name=generator content="Hugo 0.88.1"><meta name=theme-color content="#16171d">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=format-detection content="telephone=no, date=no, address=no, email=no">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<title>MIT6.828 | Lab 1: Booting a PC - Part 3: The Kernel | The Daily Awesome</title>
<link rel=stylesheet href=/css/meme.min.c7b66d8ab937ea5489e87c6d96c470e3f5e7b5a21a385e18c358b7b3be61b6de.css>
<script src=/js/meme.min.8cbe976441b5181abfd3093c9beee209b19cdbb1fa77c48d225a83ba81fa3fb1.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=stylesheet href="https://fonts.loli.net/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'">
<noscript><link rel=stylesheet href="https://fonts.loli.net/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript>
<meta name=author content="Jiachen Zhang"><meta name=description content="开始详细了解最小的JOS内核。与 boot loader 类似，内核也从汇编语言开始，从而使C语言代码能够执行。 1. 虚拟内存解决位置依赖问题 - Using virtual memory to work around position dependence 在 Part2 中可以发现内存的加载地址LMA和链接地址VMA差别非常大： [post cid=&#34;535&#34; /] obj/kern/kernel: file format elf32-i386 Sections: Idx Name Size VMA LMA File off Algn 0 .text 000019e9 f0100000 00100000 00001000 2**4 CONTENTS, ALLOC, LOAD, READONLY, CODE 操作系统内存通常链接并运行在非常高的虚拟地址上，……">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#2a6df4>
<link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png>
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-title content="The Daily Awesome">
<meta name=apple-mobile-web-app-status-bar-style content="black">
<meta name=mobile-web-app-capable content="yes">
<meta name=application-name content="The Daily Awesome">
<meta name=msapplication-starturl content="../">
<meta name=msapplication-TileColor content="#fff">
<meta name=msapplication-TileImage content="../icons/mstile-150x150.png">
<link rel=manifest href=/manifest.json>
<link rel=canonical href=https://www.zhangjc.site/archives-539/>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2019-06-15T07:39:00+00:00","dateModified":"2021-10-01T20:54:44+08:00","url":"https://www.zhangjc.site/archives-539/","headline":"MIT6.828 | Lab 1: Booting a PC - Part 3: The Kernel","description":"开始详细了解最小的JOS内核。与 boot loader 类似，内核也从汇编语言开始，从而使C语言代码能够执行。 1. 虚拟内存解决位置依赖问题 - Using virtual memory to work around position dependence 在 Part2 中可以发现内存的加载地址LMA和链接地址VMA差别非常大： [post cid=\"535\" /] obj/kern/kernel: file format elf32-i386 Sections: Idx Name Size VMA LMA File off Algn 0 .text 000019e9 f0100000 00100000 00001000 2**4 CONTENTS, ALLOC, LOAD, READONLY, CODE 操作系统内存通常链接并运行在非常高的虚拟地址上，……","inLanguage":"zh-CN","articleSection":"tech","wordCount":3979,"image":"https://www.zhangjc.site/icons/apple-touch-icon.png","author":{"@type":"Person","description":"The Daily Awesome","email":"zhangjc1999@gmail.com","image":"https://www.zhangjc.site/icons/apple-touch-icon.png","url":"https://www.zhangjc.site/","name":"Jiachen"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)","publisher":{"@type":"Organization","name":"The Daily Awesome","logo":{"@type":"ImageObject","url":"https://www.zhangjc.site/icons/apple-touch-icon.png"},"url":"https://www.zhangjc.site/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://www.zhangjc.site/"}}</script>
<meta name=twitter:card content="summary">
<meta name=twitter:site content="@JiachenZhang5">
<meta name=twitter:creator content="@JiachenZhang5">
<meta property="og:title" content="MIT6.828 | Lab 1: Booting a PC - Part 3: The Kernel">
<meta property="og:description" content="开始详细了解最小的JOS内核。与 boot loader 类似，内核也从汇编语言开始，从而使C语言代码能够执行。 1. 虚拟内存解决位置依赖问题 - Using virtual memory to work around position dependence 在 Part2 中可以发现内存的加载地址LMA和链接地址VMA差别非常大： [post cid=&#34;535&#34; /] obj/kern/kernel: file format elf32-i386 Sections: Idx Name Size VMA LMA File off Algn 0 .text 000019e9 f0100000 00100000 00001000 2**4 CONTENTS, ALLOC, LOAD, READONLY, CODE 操作系统内存通常链接并运行在非常高的虚拟地址上，……">
<meta property="og:url" content="https://www.zhangjc.site/archives-539/">
<meta property="og:site_name" content="The Daily Awesome">
<meta property="og:locale" content="zh"><meta property="og:image" content="https://www.zhangjc.site/icons/apple-touch-icon.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-06-15T07:39:00+00:00">
<meta property="article:modified_time" content="2021-10-01T20:54:44+08:00">
<meta property="article:section" content="tech">
<script type=text/javascript src="https://s4.cnzz.com/z_stat.php?id=1279769355&web_id=1279769355"></script>
</head>
<body>
<div class=container>
<header class=header>
<div class=header-wrapper>
<div class="header-inner single">
<div class=site-brand>
<a href=/ class=brand>The Daily Awesome</a>
</div>
<nav class=nav>
<ul class=menu id=menu>
<li class=menu-item><a href=/life/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7.0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6.0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6.0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3.0 64v48c0 8.8 7.2 16 16 16h480c8.8.0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class=menu-item-name>生活</span></a>
</li>
<li class=menu-item><a href=/tech/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon th"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255.0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256.0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255.0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256.0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255.0-24 10.745-24 24zm386.667-56H488c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24z"/></svg><span class=menu-item-name>技术</span></a>
</li>
<li class=menu-item><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6.0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7.0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4.0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9s28-2.7 40.9-6.9c2.3-.7 4.7-1.1 7.1-1.1 42.9.0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class=menu-item-name>关于</span></a>
</li>
<li class=menu-item>
<a id=theme-switcher href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5 242 7a18 18 0 0128 0l48.8 97.5L422.2 70A18 18 0 01442 89.8l-34.5 103.4L505 242a18 18 0 010 28l-97.5 48.8L442 422.2A18 18 0 01422.2 442l-103.4-34.5L270 505a18 18 0 01-28 0l-48.8-97.5L89.8 442A18 18 0 0170 422.2l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8L70 89.8A18 18 0 0189.8 70zM256 128a128 128 0 10.01.0M256 160a96 96 0 10.01.0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412A256 256 0 10181 5a11.5 11.5.0 00-5 20A201.5 201.5.0 0142 399a11.5 11.5.0 00-15 13"/></svg></a>
</li>
</ul>
</nav>
</div>
</div>
<input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label>
</header>
<main class="main single" id=main>
<div class=main-inner>
<article class="content post h-entry" data-align=justify data-type=tech data-toc-num=true>
<h1 class="post-title p-name">MIT6.828 | Lab 1: Booting a PC - Part 3: The Kernel</h1>
<div class=post-meta>
<time datetime=2019-06-15T07:39:00+00:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2019.6.15</time>
<span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href=/tech/ class="category-link p-category">Tech</a></span>
</div>
<nav class=contents>
<ol class=toc>
<li><a id=contents:1-虚拟内存解决位置依赖问题---using-virtual-memory-to-work-around-position-dependence href=#1-虚拟内存解决位置依赖问题---using-virtual-memory-to-work-around-position-dependence>1. 虚拟内存解决位置依赖问题 - Using virtual memory to work around position dependence</a></li>
<li><a id=contents:2-formatted-printing-to-the-console---格式化打印至控制台 href=#2-formatted-printing-to-the-console---格式化打印至控制台>2. Formatted Printing to the Console - 格式化打印至控制台</a></li>
<li><a id=contents:3-the-stack-栈 href=#3-the-stack-栈>3. The Stack 栈</a></li>
<li><a id=contents:other-questions href=#other-questions>Other Questions</a></li>
<li><a id=contents:exe7-查看分页效果 href=#exe7-查看分页效果>Exe7. 查看分页效果</a></li>
<li><a id=contents:exe8-打印八进制 href=#exe8-打印八进制>Exe8. 打印八进制</a></li>
<li><a id=contents:exe9-stack-size href=#exe9-stack-size>Exe9. Stack size</a></li>
<li><a id=contents:exe10-back-trace href=#exe10-back-trace>Exe10. back trace</a></li>
<li><a id=contents:exe11 href=#exe11>Exe11.</a></li>
<li><a id=contents:exe12-debug-with-stab href=#exe12-debug-with-stab>Exe12. Debug with STAB</a></li>
</ol>
</nav><div class="post-body e-content">
<p>开始详细了解最小的<code>JOS</code>内核。与 <code>boot loader</code> 类似，内核也从汇编语言开始，从而使C语言代码能够执行。</p>
<h2 id=1-虚拟内存解决位置依赖问题---using-virtual-memory-to-work-around-position-dependence><a href=#1-虚拟内存解决位置依赖问题---using-virtual-memory-to-work-around-position-dependence class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:1-虚拟内存解决位置依赖问题---using-virtual-memory-to-work-around-position-dependence class=headings>1. 虚拟内存解决位置依赖问题 - Using virtual memory to work around position dependence</a></h2>
<p>在 Part2 中可以发现内存的加载地址<code>LMA</code>和链接地址<code>VMA</code>差别非常大：</p>
<p>[post cid="535" /]</p>
<pre tabindex=0><code>obj/kern/kernel:     file format elf32-i386 

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .text         000019e9  f0100000  00100000  00001000  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE

</code></pre><p>操作系统内存通常链接并运行在非常高的虚拟地址上，例如 <code>0xf0100000</code>，从而为用户程序留下较低的虚拟地址空间。</p>
<p>In fact, in the next lab, we will map the <em>entire</em> bottom 256MB of the PC's physical address space, from physical addresses 0x00000000 through 0x0fffffff, to virtual addresses 0xf0000000 through 0xffffffff respectively. You should now see why JOS can only use the first 256MB of physical memory.</p>
<p>这次将只映射物理地址的前 <code>4MB</code>，使用<code>kern/entrypgdir.c</code>中手写的，静态初始化的 <code>page directory</code> 和 <code>page table</code> 来完成此操作。</p>
<p><code>kern/entry.S</code> 设置 <code>CR0_PG</code> 标志后，虚拟地址便可以翻译至物理地址。</p>
<p>虚拟地址: [<code>0xf0000000</code>, <code>0xf0400000</code>] => 物理地址 [<code>0x00000000</code>, <code>0x004000000</code>]</p>
<p>!> 这个范围以外的地址引用会引发硬件异常，since we haven't set up interrupt handling yet</p>
<p><strong>Exe7</strong></p>
<h2 id=2-formatted-printing-to-the-console---格式化打印至控制台><a href=#2-formatted-printing-to-the-console---格式化打印至控制台 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:2-formatted-printing-to-the-console---格式化打印至控制台 class=headings>2. Formatted Printing to the Console - 格式化打印至控制台</a></h2>
<p><strong>Exe8</strong></p>
<h2 id=3-the-stack-栈><a href=#3-the-stack-栈 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:3-the-stack-栈 class=headings>3. The Stack 栈</a></h2>
<p>在本实验的最后练习中，我们将更详细地探讨C语言在x86上使用堆栈的方式，并在此过程中<strong>编写一个有用的新内核监视器函数</strong>，用于<strong>打印堆栈的回溯</strong>：保存来自嵌套调用指令的指令指针（IP）值至当前执行点的列表。</p>
<p><strong>Exe 9.</strong></p>
<p>The x86 stack pointer (<code>esp</code> register) points to the lowest location on the stack that is currently in use.</p>
<p>栈自顶向底使用</p>
<p>The <code>ebp</code> (base pointer) register, in contrast, is associated with the stack primarily by software convention.</p>
<h2 id=other-questions><a href=#other-questions class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:other-questions class=headings>Other Questions</a></h2>
<p>Explain the interface between <code>printf.c</code> and <code>console.c</code>. Specifically, what function does <code>console.c</code> export? How is this function used by <code>printf.c</code>?</p>
<p><code>console.c</code> export <code>cputchar</code></p>
<p><code>printf.c</code>: <code>cputchar</code> was called in function <code>putch</code></p>
<p>Explain the following from <code>console.c</code>:</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=mi>1</span>      <span class=nf>if</span> <span class=p>(</span><span class=n>crt_pos</span> <span class=o>&gt;=</span> <span class=n>CRT_SIZE</span><span class=p>)</span> <span class=p>{</span>
<span class=mi>2</span>              <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
<span class=mi>3</span>              <span class=n>memmove</span><span class=p>(</span><span class=n>crt_buf</span><span class=p>,</span> <span class=n>crt_buf</span> <span class=o>+</span> <span class=n>CRT_COLS</span><span class=p>,</span> <span class=p>(</span><span class=n>CRT_SIZE</span> <span class=o>-</span> <span class=n>CRT_COLS</span><span class=p>)</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>uint16_t</span><span class=p>));</span>
<span class=mi>4</span>              <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>CRT_SIZE</span> <span class=o>-</span> <span class=n>CRT_COLS</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>CRT_SIZE</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
<span class=mi>5</span>                      <span class=n>crt_buf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x0700</span> <span class=o>|</span> <span class=sc>&#39; &#39;</span><span class=p>;</span>
<span class=mi>6</span>              <span class=n>crt_pos</span> <span class=o>-=</span> <span class=n>CRT_COLS</span><span class=p>;</span>
<span class=mi>7</span>      <span class=p>}</span>

</code></pre></td></tr></table></div>
</div>
</div><p>完整方法如下：</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=kt>void</span>
<span class=nf>cga_putc</span><span class=p>(</span><span class=kt>int</span> <span class=n>c</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// if no attribute given, then use black on white
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>c</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xFF</span><span class=p>))</span>
        <span class=n>c</span> <span class=o>|=</span> <span class=mh>0x0700</span><span class=p>;</span>

    <span class=k>switch</span> <span class=p>(</span><span class=n>c</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=sc>&#39;\b&#39;</span><span class=o>:</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>crt_pos</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>crt_pos</span><span class=o>--</span><span class=p>;</span>
            <span class=n>crt_buf</span><span class=p>[</span><span class=n>crt_pos</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>c</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xff</span><span class=p>)</span> <span class=o>|</span> <span class=sc>&#39; &#39;</span><span class=p>;</span>
        <span class=p>}</span>   
        <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=sc>&#39;\n&#39;</span><span class=o>:</span>
        <span class=n>crt_pos</span> <span class=o>+=</span> <span class=n>CRT_COLS</span><span class=p>;</span>
        <span class=cm>/* fallthru */</span>
    <span class=k>case</span> <span class=sc>&#39;\r&#39;</span><span class=o>:</span>
        <span class=n>crt_pos</span> <span class=o>-=</span> <span class=p>(</span><span class=n>crt_pos</span> <span class=o>%</span> <span class=n>CRT_COLS</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=sc>&#39;\t&#39;</span><span class=o>:</span>
        <span class=n>cons_putc</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
        <span class=n>cons_putc</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
        <span class=n>cons_putc</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
        <span class=n>cons_putc</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
        <span class=n>cons_putc</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=k>default</span><span class=o>:</span>
        <span class=n>crt_buf</span><span class=p>[</span><span class=n>crt_pos</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=p>;</span>     <span class=cm>/* write the character */</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// What is the purpose of this?
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>crt_pos</span> <span class=o>&gt;=</span> <span class=n>CRT_SIZE</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>

        <span class=n>memmove</span><span class=p>(</span><span class=n>crt_buf</span><span class=p>,</span> <span class=n>crt_buf</span> <span class=o>+</span> <span class=n>CRT_COLS</span><span class=p>,</span> <span class=p>(</span><span class=n>CRT_SIZE</span> <span class=o>-</span> <span class=n>CRT_COLS</span><span class=p>)</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>uint16_t</span><span class=p>));</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>CRT_SIZE</span> <span class=o>-</span> <span class=n>CRT_COLS</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>CRT_SIZE</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
    <span class=p>}</span>       <span class=n>crt_buf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x0700</span> <span class=o>|</span> <span class=sc>&#39; &#39;</span><span class=p>;</span>
        <span class=n>crt_pos</span> <span class=o>-=</span> <span class=n>CRT_COLS</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/* move that little blinky thing */</span>
    <span class=n>outb</span><span class=p>(</span><span class=n>addr_6845</span><span class=p>,</span> <span class=mi>14</span><span class=p>);</span>
    <span class=n>outb</span><span class=p>(</span><span class=n>addr_6845</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>crt_pos</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>);</span>
    <span class=n>outb</span><span class=p>(</span><span class=n>addr_6845</span><span class=p>,</span> <span class=mi>15</span><span class=p>);</span>
    <span class=n>outb</span><span class=p>(</span><span class=n>addr_6845</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>crt_pos</span><span class=p>);</span>
<span class=p>}</span>

</code></pre></td></tr></table></div>
</div>
</div><p>分析对 <code>\r</code>, <code>\n</code> 的操作可知</p>
<ul>
<li><code>CRT_COLS</code>表示一行的最大字符数</li>
<li><code>crt_pos</code> 当前光标位置</li>
<li><code>CRT_SIZE</code>表示缓存的最大字符数？</li>
</ul>
<p>可以发现在复制后，光标又后退了一整行的距离，因此这一段的作用是实现字符滚动一行。</p>
<p>For the following questions you might wish to consult the notes for Lecture 2. These notes cover GCC's calling convention on the x86. Trace the execution of the following code step-by-step:</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>3</span><span class=p>,</span> <span class=n>z</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
<span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;x %d, y %x, z %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>);</span>

</code></pre></td></tr></table></div>
</div>
</div><p>In the call to <code>cprintf()</code>, to what does <code>fmt</code> point? To what does <code>ap</code> point?</p>
<p><code>fmp</code>: 字符串地址</p>
<p><code>ap</code>: 参数地址</p>
<p>List (in order of execution) each call to <code>cons_putc</code>, <code>va_arg</code>, and <code>vcprintf</code>. For <code>cons_putc</code>, list its argument as well. For <code>va_arg</code>, list what <code>ap</code> points to before and after the call. For <code>vcprintf</code> list the values of its two arguments.</p>
<p><code>void cons_putc(int) // output a character to the console</code></p>
<p><code>vcprintf()</code> => <code>cons_putc(122)//'x'</code> => <code>cons_putc(32)//' '</code> => <code>va_arg(*ap, int)</code>( <code>ap</code> pointes before <code>x</code> after <code>y</code>) => <code>cons_putc(44)//','</code> => <code>cons_putc(32)//' '</code> => <code>cons_putc(123)//'y'</code> => <code>cons_putc(32)//' '</code> => <code>va_arg(*ap, unsigned int)</code>( <code>ap</code> pointes before <code>y</code> after <code>z</code>) Omit 最后 points NULL</p>
<p>Run the following code.</p>
<pre tabindex=0><code>    unsigned int i = 0x00646c72;
    cprintf(&quot;H%x Wo%s&quot;, 57616, &amp;i);

</code></pre><p>What is the output? Explain how this output is arrived at in the step-by-step manner of the previous exercise. <a href=http://web.cs.mun.ca/~michael/c/ascii-table.html target=_blank rel=noopener>Here's an ASCII table</a> that maps bytes to characters.</p>
<p>The output depends on that fact that the x86 is little-endian. If the x86 were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change <code>57616</code> to a different value? <a href=http://www.webopedia.com/TERM/b/big_endian.html target=_blank rel=noopener>Here's a description of little- and big-endian</a> and <a href=http://www.networksorcery.com/enp/ien/ien137.txt target=_blank rel=noopener>a more whimsical description</a>.</p>
<p>分析可知，<code>%x</code>会识别 <code>unsigned int</code> 并转换为 <code>16</code>进制，即 <code>57616</code> 转换为 <code>0xe110</code>,</p>
<p>小端表示低位数字存在低地址处，对于<code>0x00646c72</code>,一个<code>word</code>分为4个<code>byte</code>即为 <code>NUL d l r</code>,</p>
<p>因此对应输出为 <code>rld</code>，所以最终输出为<code>He110 World</code></p>
<p>In the following code, what is going to be printed after <code>y=</code>? (note: the answer is not a specific value.) Why does this happen?</p>
<p><code>cprintf("x=%d y=%d", 3);</code></p>
<p>由可变参数的方式知道会打印第一个参数之上的栈里面的4字节内容</p>
<p>Let's say that GCC changed its calling convention so that it pushed arguments on the stack in declaration order, so that the last argument is pushed last. How would you have to change <code>cprintf</code> or its interface so that it would still be possible to pass it a variable number of arguments?</p>
<p>如果GCC参数入栈方式改为从左往右，那么</p>
<ul>
<li>方案一：对于字符串的检测方式需要改变为从右往左，格式化片段也要倒着写</li>
<li>方案二：为 <code>cprintf</code> 函数增加一个表示参数个数的参数来辅助移动栈指针</li>
</ul>
<h2 id=exe7-查看分页效果><a href=#exe7-查看分页效果 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:exe7-查看分页效果 class=headings>Exe7. 查看分页效果</a></h2>
<p>Use QEMU and GDB to trace into the JOS kernel and stop at the <code>movl %eax, %cr0</code>. Examine memory at 0x00100000 and at 0xf0100000. Now, single step over that instruction using the <code>stepi</code> GDB command. Again, examine memory at 0x00100000 and at 0xf0100000. Make sure you understand what just happened.</p>
<p>What is the first instruction <em>after</em> the new mapping is established that would fail to work properly if the mapping weren't in place? Comment out the <code>movl %eax, %cr0</code> in <code>kern/entry.S</code>, trace into it, and see if you were right.</p>
<p>查看 <code>obj/kern/kernel.asm</code> ：</p>
<pre tabindex=0><code>	movl	%eax, %cr0
f0100025:	0f 22 c0             	mov    %eax,%cr0

</code></pre><p>因此在映射前，这条指令的地址为 <code>0x00100025</code>，使用<code>gdb</code>:</p>
<pre tabindex=0><code>(gdb) b *0x00100025 
Breakpoint 1 at 0x100025 
(gdb) c 
Continuing. 
The target architecture is assumed to be i386 
=&gt; 0x100025:    mov    %eax,%cr0

Breakpoint 1, 0x00100025 in ?? ()
(gdb) x/8x 0x00100000 
0x100000:       0x1badb002      0x00000000      0xe4524ffe      0x7205c766 
0x100010:       0x34000004      0x2000b812      0x220f0011      0xc0200fd8
(gdb) x/8x 0xf0100000 
0xf0100000 &lt;_start+4026531828&gt;: 0x00000000      0x00000000      0x00000000      0x00000000 
0xf0100010 &lt;entry+4&gt;:   0x00000000      0x00000000      0x00000000      0x00000000
(gdb) si 
=&gt; 0x100028:    mov    $0xf010002f,%eax 
0x00100028 in ?? ()
(gdb) x/8x 0x00100000 
0x100000:       0x1badb002      0x00000000      0xe4524ffe      0x7205c766 
0x100010:       0x34000004      0x2000b812      0x220f0011      0xc0200fd8
(gdb) x/8x 0xf0100000 
0xf0100000 &lt;_start+4026531828&gt;: 0x1badb002      0x00000000      0xe4524ffe      0x7205c766 
0xf0100010 &lt;entry+4&gt;:   0x34000004      0x2000b812      0x220f0011      0xc0200fd8

</code></pre><p>可以发现， <code>movl %eax, %cr0</code> 这条指令完成了物理内存向虚拟内存的映射。</p>
<p>在 <code>kern/entry.S</code> 中注释掉该命令后，运行 <code>make clean && make</code> 重新编译，</p>
<pre tabindex=0><code>+ symbol-file obj/kern/kernel
(gdb) b *0x00100025
Breakpoint 1 at 0x100025 
(gdb) c 
Continuing. 
The target architecture is assumed to be i386 
=&gt; 0x100025:    mov    $0xf010002c,%eax

Breakpoint 1, 0x00100025 in ?? ()
(gdb) si 
=&gt; 0x10002a:    jmp    *%eax 
0x0010002a in ?? ()
(gdb) si 
=&gt; 0xf010002c &lt;relocated&gt;:      add    %al,(%eax) 
relocated () at kern/entry.S:74
74              movl    $0x0,%ebp                       # nuke frame pointer
(gdb) si 
Remote connection closed 

</code></pre><p>报错信息为：<code>qemu: fatal: Trying to execute code outside RAM or ROM at 0xf010002c</code></p>
<h2 id=exe8-打印八进制><a href=#exe8-打印八进制 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:exe8-打印八进制 class=headings>Exe8. 打印八进制</a></h2>
<p>We have omitted a small fragment of code - the code necessary to print octal numbers using patterns of the form "%o". Find and fill in this code fragment.</p>
<p>in <code>lib/printfmt.c</code>:</p>
<p>观察打印无符号整数 <code>%u</code> ：</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>        <span class=c1>// unsigned decimal
</span><span class=c1></span>        <span class=k>case</span> <span class=sc>&#39;u&#39;</span><span class=o>:</span>
            <span class=n>num</span> <span class=o>=</span> <span class=n>getuint</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ap</span><span class=p>,</span> <span class=n>lflag</span><span class=p>);</span>
            <span class=n>base</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
            <span class=k>goto</span> <span class=n>number</span><span class=p>;</span>

</code></pre></td></tr></table></div>
</div>
</div><p>因此打印八进制 <code>%o</code> 应该为：</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>        <span class=c1>// (unsigned) octal
</span><span class=c1></span>        <span class=k>case</span> <span class=sc>&#39;u&#39;</span><span class=o>:</span>
            <span class=n>num</span> <span class=o>=</span> <span class=n>getuint</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ap</span><span class=p>,</span> <span class=n>lflag</span><span class=p>);</span>
            <span class=n>base</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
            <span class=k>goto</span> <span class=n>number</span><span class=p>;</span>

</code></pre></td></tr></table></div>
</div>
</div><h2 id=exe9-stack-size><a href=#exe9-stack-size class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:exe9-stack-size class=headings>Exe9. Stack size</a></h2>
<p><strong>Exercise 9.</strong> Determine where the kernel initializes its stack, and exactly where in memory its stack is located. How does the kernel reserve space for its stack? And at which "end" of this reserved area is the stack pointer initialized to point to?</p>
<p>in <code>kern/entry.S</code></p>
<pre tabindex=0><code class=language-assembly data-lang=assembly>relocated:

    # Clear the frame pointer register (EBP)
    # so that once we get into debugging C code,
    # stack backtraces will be terminated properly.
    movl    $0x0,%ebp           # nuke frame pointer

    # Set the stack pointer
    movl    $(bootstacktop),%esp

</code></pre><p>in <code>pbj/kern/kernel.asm</code></p>
<pre tabindex=0><code class=language-assembly data-lang=assembly>    # Clear the frame pointer register (EBP)
    # so that once we get into debugging C code,
    # stack backtraces will be terminated properly.
    movl    $0x0,%ebp           # nuke frame pointer
f010002f:   bd 00 00 00 00          mov    $0x0,%ebp

    # Set the stack pointer
    movl    $(bootstacktop),%esp
f0100034:   bc 00 00 11 f0          mov    $0xf0110000,%esp

</code></pre><p>因此栈开始于 <code>0xf0110000</code></p>
<p>in <code>kern/entry.S</code></p>
<pre tabindex=0><code class=language-assembly data-lang=assembly>.data
###################################################################
# boot stack
###################################################################
    .p2align    PGSHIFT     # force page alignment
    .globl      bootstack
bootstack:
    .space      KSTKSIZE
    .globl      bootstacktop
bootstacktop:

</code></pre><p>由此可知，栈空间的大小为 为 <code>KSTKSIZE</code></p>
<h2 id=exe10-back-trace><a href=#exe10-back-trace class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:exe10-back-trace class=headings>Exe10. back trace</a></h2>
<p><strong>Exercise 10.</strong> To become familiar with the C calling conventions on the x86, find the address of the <code>test_backtrace</code> function in <code>obj/kern/kernel.asm</code>, set a breakpoint there, and examine what happens each time it gets called after the kernel starts. How many 32-bit words does each recursive nesting level of <code>test_backtrace</code> push on the stack, and what are those words?</p>
<p>Note that, for this exercise to work properly, you should be using the patched version of QEMU available on the <a href=https://pdos.csail.mit.edu/6.828/2018/tools.html target=_blank rel=noopener>tools</a> page or on Athena. Otherwise, you'll have to manually translate all breakpoint and memory addresses to linear addresses.</p>
<p>in <code>obj/kern/kernel.asm</code></p>
<pre tabindex=0><code class=language-assembly data-lang=assembly>// Test the stack backtrace function (lab 1 only)
void
test_backtrace(int x)
{
f0100040:	55                   	push   %ebp
f0100041:	89 e5                	mov    %esp,%ebp
f0100043:	56                   	push   %esi
f0100044:	53                   	push   %ebx
f0100045:	e8 72 01 00 00       	call   f01001bc &lt;__x86.get_pc_thunk.bx&gt;
f010004a:	81 c3 be 12 01 00    	add    $0x112be,%ebx
f0100050:	8b 75 08             	mov    0x8(%ebp),%esi
	cprintf(&quot;entering test_backtrace %d\n&quot;, x);
f0100053:	83 ec 08             	sub    $0x8,%esp
f0100056:	56                   	push   %esi
f0100057:	8d 83 f8 06 ff ff    	lea    -0xf908(%ebx),%eax
f010005d:	50                   	push   %eax
f010005e:	e8 e6 09 00 00       	call   f0100a49 &lt;cprintf&gt;
	if (x &gt; 0)
f0100063:	83 c4 10             	add    $0x10,%esp
f0100066:	85 f6                	test   %esi,%esi
f0100068:	7f 2b                	jg     f0100095 &lt;test_backtrace+0x55&gt;
		test_backtrace(x-1);
	else
		mon_backtrace(0, 0, 0);
f010006a:	83 ec 04             	sub    $0x4,%esp
f010006d:	6a 00                	push   $0x0
f010006f:	6a 00                	push   $0x0
f0100071:	6a 00                	push   $0x0
f0100073:	e8 0b 08 00 00       	call   f0100883 &lt;mon_backtrace&gt;
f0100078:	83 c4 10             	add    $0x10,%esp
	cprintf(&quot;leaving test_backtrace %d\n&quot;, x);
f010007b:	83 ec 08             	sub    $0x8,%esp
f010007e:	56                   	push   %esi
f010007f:	8d 83 14 07 ff ff    	lea    -0xf8ec(%ebx),%eax
f0100085:	50                   	push   %eax
f0100086:	e8 be 09 00 00       	call   f0100a49 &lt;cprintf&gt;
}
f010008b:	83 c4 10             	add    $0x10,%esp
f010008e:	8d 65 f8             	lea    -0x8(%ebp),%esp
f0100091:	5b                   	pop    %ebx
f0100092:	5e                   	pop    %esi
f0100093:	5d                   	pop    %ebp
f0100094:	c3                   	ret    
		test_backtrace(x-1);
f0100095:	83 ec 0c             	sub    $0xc,%esp
f0100098:	8d 46 ff             	lea    -0x1(%esi),%eax
f010009b:	50                   	push   %eax
f010009c:	e8 9f ff ff ff       	call   f0100040 &lt;test_backtrace&gt;
f01000a1:	83 c4 10             	add    $0x10,%esp
f01000a4:	eb d5                	jmp    f010007b &lt;test_backtrace+0x3b&gt;

</code></pre><p>using <code>gdb</code></p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>+ symbol-file obj/kern/kernel
<span class=o>(</span>gdb<span class=o>)</span> b *0xf0100040 
Breakpoint <span class=m>1</span> at 0xf0100040: file kern/init.c, line 13. 
<span class=o>(</span>gdb<span class=o>)</span> c 
Continuing. 
The target architecture is assumed to be <span class=nv>i386</span> 
<span class=o>=</span>&gt; 0xf0100040 &lt;test_backtrace&gt;: push   %ebp

<span class=m>13</span>      <span class=o>{</span>
<span class=o>(</span>gdb<span class=o>)</span> i r
eax            0x0      <span class=m>0</span>
ecx            0x3d4    <span class=m>980</span>
edx            0x3d5    <span class=m>981</span>
ebx            0xf0111308       -267316472
esp            0xf010ffdc       0xf010ffdc
ebp            0xf010fff8       0xf010fff8
esi            0x10094  <span class=m>65684</span>
edi            0x0      <span class=m>0</span>
eip            0xf0100040       0xf0100040 &lt;test_backtrace&gt;
eflags         0x46     <span class=o>[</span> PF ZF <span class=o>]</span>
cs             0x8      <span class=m>8</span>
ss             0x10     <span class=m>16</span>
ds             0x10     <span class=m>16</span>
es             0x10     <span class=m>16</span>
fs             0x10     <span class=m>16</span>
gs             0x10     <span class=m>16</span>
<span class=o>(</span>gdb<span class=o>)</span> c
Continuing.
<span class=o>=</span>&gt; 0xf0100040 &lt;test_backtrace&gt;: push   %ebp

Breakpoint 1, test_backtrace <span class=o>(</span><span class=nv>x</span><span class=o>=</span>4<span class=o>)</span> at kern/init.c:13
<span class=m>13</span>      <span class=o>{</span>
<span class=o>(</span>gdb<span class=o>)</span> i r
eax            0x4      <span class=m>4</span>
ecx            0x3d4    <span class=m>980</span>
edx            0x3d5    <span class=m>981</span>
ebx            0xf0111308       -267316472
esp            0xf010ffbc       0xf010ffbc
ebp            0xf010ffd8       0xf010ffd8
esi            0x5      <span class=m>5</span>
edi            0x0      <span class=m>0</span>
eip            0xf0100040       0xf0100040 &lt;test_backtrace&gt;
eflags         0x92     <span class=o>[</span> AF SF <span class=o>]</span>
cs             0x8      <span class=m>8</span>
ss             0x10     <span class=m>16</span>
ds             0x10     <span class=m>16</span>
es             0x10     <span class=m>16</span>
fs             0x10     <span class=m>16</span>
gs             0x10     <span class=m>16</span>
<span class=o>(</span>gdb<span class=o>)</span>

</code></pre></td></tr></table></div>
</div>
</div><p>可以发现两次 <code>epb</code> 的差值为 <code>0x20</code>, which is <code>32 bits</code> = <code>4*8 bytes</code> = <code>1 word</code></p>
<h2 id=exe11><a href=#exe11 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:exe11 class=headings>Exe11.</a></h2>
<p>in</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span>
<span class=nf>mon_backtrace</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>,</span> <span class=k>struct</span> <span class=n>Trapframe</span> <span class=o>*</span><span class=n>tf</span><span class=p>)</span>
<span class=p>{</span>
	<span class=kt>uint32_t</span><span class=o>*</span> <span class=n>ebp</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=o>*</span><span class=p>)</span> <span class=n>read_ebp</span><span class=p>();</span>
  	<span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;Stack backtrace:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
  	<span class=k>while</span> <span class=p>(</span><span class=n>ebp</span><span class=p>)</span> <span class=p>{</span>
		<span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;ebp %x  eip %x  args&#34;</span><span class=p>,</span> <span class=n>ebp</span><span class=p>,</span> <span class=o>*</span><span class=p>(</span><span class=n>ebp</span><span class=o>+</span><span class=mi>1</span><span class=p>));</span>
		<span class=n>cprintf</span><span class=p>(</span><span class=s>&#34; %8x&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>(</span><span class=n>ebp</span><span class=o>+</span><span class=mi>2</span><span class=p>));</span>
		<span class=n>cprintf</span><span class=p>(</span><span class=s>&#34; %8x&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>(</span><span class=n>ebp</span><span class=o>+</span><span class=mi>3</span><span class=p>));</span>
		<span class=n>cprintf</span><span class=p>(</span><span class=s>&#34; %8x&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>(</span><span class=n>ebp</span><span class=o>+</span><span class=mi>4</span><span class=p>));</span>
		<span class=n>cprintf</span><span class=p>(</span><span class=s>&#34; %8x&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>(</span><span class=n>ebp</span><span class=o>+</span><span class=mi>5</span><span class=p>));</span>
		<span class=n>cprintf</span><span class=p>(</span><span class=s>&#34; %8x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>(</span><span class=n>ebp</span><span class=o>+</span><span class=mi>6</span><span class=p>));</span>
		<span class=n>ebp</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=o>*</span><span class=p>)</span> <span class=o>*</span><span class=n>ebp</span><span class=p>;</span>
  	<span class=c1>//ebp f0109e58  eip f0100a62  args 00000001 f0109e80 f0109e98 f0100ed2 00000031
</span><span class=c1></span>  	<span class=p>}</span>
	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

</code></pre></td></tr></table></div>
</div>
</div><p>output of <code>gdb</code>:</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>qemu-system-i386 -nographic -drive <span class=nv>file</span><span class=o>=</span>obj/kern/kernel.img,index<span class=o>=</span>0,media<span class=o>=</span>disk,format<span class=o>=</span>raw -serial mon:stdio -gdb tcp::26000 -D qemu.log  -S
<span class=m>6828</span> decimal is  octal!
entering test_backtrace <span class=m>5</span>
entering test_backtrace <span class=m>4</span>
entering test_backtrace <span class=m>3</span>
entering test_backtrace <span class=m>2</span>
entering test_backtrace <span class=m>1</span>
entering test_backtrace <span class=m>0</span>
Stack backtrace:
ebp f010ff18  eip f0100078  args        <span class=m>0</span>        <span class=m>0</span>        <span class=m>0</span> f010004a f0111308
ebp f010ff38  eip f01000a1  args        <span class=m>0</span>        <span class=m>1</span> f010ff78 f010004a f0111308
ebp f010ff58  eip f01000a1  args        <span class=m>1</span>        <span class=m>2</span> f010ff98 f010004a f0111308
ebp f010ff78  eip f01000a1  args        <span class=m>2</span>        <span class=m>3</span> f010ffb8 f010004a f0111308
ebp f010ff98  eip f01000a1  args        <span class=m>3</span>        <span class=m>4</span>        <span class=m>0</span> f010004a f0111308
ebp f010ffb8  eip f01000a1  args        <span class=m>4</span>        <span class=m>5</span>        <span class=m>0</span> f010004a f0111308
ebp f010ffd8  eip f01000f4  args        <span class=m>5</span>     1aac      <span class=m>640</span>        <span class=m>0</span>        <span class=m>0</span>
ebp f010fff8  eip f010003e  args        <span class=m>3</span>     <span class=m>1003</span>     <span class=m>2003</span>     <span class=m>3003</span>     <span class=m>4003</span>
leaving test_backtrace <span class=m>0</span>
leaving test_backtrace <span class=m>1</span>
leaving test_backtrace <span class=m>2</span>
leaving test_backtrace <span class=m>3</span>
leaving test_backtrace <span class=m>4</span>
leaving test_backtrace <span class=m>5</span>
Welcome to the JOS kernel monitor!
Type <span class=s1>&#39;help&#39;</span> <span class=k>for</span> a list of commands.
K&gt;

</code></pre></td></tr></table></div>
</div>
</div><h2 id=exe12-debug-with-stab><a href=#exe12-debug-with-stab class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:exe12-debug-with-stab class=headings>Exe12. Debug with STAB</a></h2>
<p>打印 <code>mon_backtrace()</code> 中对应每个 eip 的函数名、文件名和行号，在<code>kern/kdebug.c</code>中的函数 <code>debuginfo_eip()</code>添加查询行号的代码，然后完善 <code>mon_backtrace</code> 函数打印文件名、函数名及行号信息。</p>
<p>在编译内核的时候，我们可以看到加了 <code>-Wall -Wno-format -Wno-unused -Werror -gstabs -m32</code>，通过<code>-gstabs</code>参数在可执行文件中加了调试信息。</p>
<p><code>STAB (Symbol TABle)</code> ==> <a href=http://www.math.utah.edu/docs/info/stabs_1.html target=_blank rel=noopener>this</a></p>
<p>常见的stabs和stabn的定义如下：</p>
<pre tabindex=0><code>.stabs &quot;string&quot;,type,0,desc,value
.stabn          type,0,desc,value
.stabd          type,0,desc

</code></pre><p>其中string的格式为</p>
<pre tabindex=0><code>&quot;name[:symbol_descriptor]
     [type_number[=type_descriptor ...]]&quot;

</code></pre><p>参见 <code>inc/stab.h</code> 可以看到stabs结构的定义和常见的stabs类型：</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>struct</span> <span class=n>Stab</span> <span class=p>{</span>
	<span class=kt>uint32_t</span> <span class=n>n_strx</span><span class=p>;</span>	<span class=c1>// index into string table of name
</span><span class=c1></span>	<span class=kt>uint8_t</span> <span class=n>n_type</span><span class=p>;</span>         <span class=c1>// type of symbol
</span><span class=c1></span>	<span class=kt>uint8_t</span> <span class=n>n_other</span><span class=p>;</span>        <span class=c1>// misc info (usually empty)
</span><span class=c1></span>	<span class=kt>uint16_t</span> <span class=n>n_desc</span><span class=p>;</span>        <span class=c1>// description field
</span><span class=c1></span>	<span class=n>uintptr_t</span> <span class=n>n_value</span><span class=p>;</span>	<span class=c1>// value of symbol
</span><span class=c1></span><span class=p>};</span>

<span class=cp>#define	N_FUN		0x24	</span><span class=c1>// procedure name
</span><span class=c1></span><span class=cp>#define	N_SLINE		0x44	</span><span class=c1>// text segment line number
</span><span class=c1></span><span class=cp>#define	N_SO		0x64	</span><span class=c1>// main source file name
</span><span class=c1></span><span class=cp>#define	N_SOL		0x84	</span><span class=c1>// included source file name
</span><span class=c1></span>
</code></pre></td></tr></table></div>
</div>
</div><p>一个简单的例子：</p>
<pre tabindex=0><code>#include&lt;stdio.h&gt;
int main()
{
	printf(&quot;hello world\n&quot;);
	return 0;
}

int foo(int a) {
	printf(&quot;function foo\n&quot;);
	return 0;
}

</code></pre><p>运行命令：</p>
<pre tabindex=0><code>gcc -Wno-format -Wno-unused -Werror -gstabs -m32 -S -o hello.s hello.c 

</code></pre><p>可以看到 hello.s 中的一些stabs：</p>
<pre tabindex=0><code>	.stabs	&quot;hello.c&quot;,100,0,2,.Ltext0
	.text
.Ltext0:
...
	.stabs	&quot;main:F(0,1)&quot;,36,0,0,main
	
main:
	.stabn	68,0,3,.LM0-.LFBB1
	.stabs	&quot;foo:F(0,1)&quot;,36,0,0,foo
	.stabs	&quot;a:p(0,1)&quot;,160,0,0,8
foo:
	.stabn	68,0,8,.LM4-.LFBB2

</code></pre><p>其中第1行是描述源文件信息的，文件名是 hello.c，类型是N_SO（100），后面的desc=2表示C语言文件，.Ltext0为文件对应代码区的开始地址。</p>
<p>第2行stabs是描述main函数的，内容分别是函数名，函数类型F(全局），以及返回值为int。类型为 N_FUNC (36)，后面的main是函数起始地址。第4行stabs描述foo函数，同理。</p>
<p>第3行的stabn描述的是行号信息，其中 68 是类型 N_SLINE，后面的0是other值，不用管。而desc为3是main函数在源文件中的行号，value是源代码行的起始地址。第5行的stabn同理。关于stabs的详细信息请<a href=http://sourceware.org/gdb/onlinedocs/stabs.html target=_blank rel=noopener>参考</a>.</p>
<p>在 <code>kdebug.c</code> 的 <code>debuginfo_eip</code>函数偏最后的注释位置添加如下代码：</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>	<span class=n>stab_binsearch</span><span class=p>(</span><span class=n>stabs</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>lline</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rline</span><span class=p>,</span> <span class=n>N_SLINE</span><span class=p>,</span> <span class=n>addr</span><span class=p>);</span>
	<span class=n>info</span><span class=o>-&gt;</span><span class=n>eip_line</span> <span class=o>=</span> <span class=n>stabs</span><span class=p>[</span><span class=n>lline</span><span class=p>].</span><span class=n>n_desc</span><span class=p>;</span>

</code></pre></td></tr></table></div>
</div>
</div><p>修改<code>monitor.c</code> 的 <code>backtrace</code> 函数 :</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span>
<span class=nf>backtrace</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>,</span> <span class=k>struct</span> <span class=n>Trapframe</span> <span class=o>*</span><span class=n>tf</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>uint32_t</span><span class=o>*</span> <span class=n>ebp</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=o>*</span><span class=p>)</span> <span class=n>read_ebp</span><span class=p>();</span>
  <span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;Stack backtrace:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
  <span class=k>while</span> <span class=p>(</span><span class=n>ebp</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>uint32_t</span> <span class=n>eip</span> <span class=o>=</span> <span class=n>ebp</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
    <span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;ebp %x  eip %x  args&#34;</span><span class=p>,</span> <span class=n>ebp</span><span class=p>,</span> <span class=n>eip</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>6</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
      <span class=n>cprintf</span><span class=p>(</span><span class=s>&#34; %08.x&#34;</span><span class=p>,</span> <span class=n>ebp</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
    <span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>struct</span> <span class=n>Eipdebuginfo</span> <span class=n>info</span><span class=p>;</span>
    <span class=n>debuginfo_eip</span><span class=p>(</span><span class=n>eip</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>info</span><span class=p>);</span>
    <span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>%s:%d: %.*s+%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
      <span class=n>info</span><span class=p>.</span><span class=n>eip_file</span><span class=p>,</span> <span class=n>info</span><span class=p>.</span><span class=n>eip_line</span><span class=p>,</span>
      <span class=n>info</span><span class=p>.</span><span class=n>eip_fn_namelen</span><span class=p>,</span> <span class=n>info</span><span class=p>.</span><span class=n>eip_fn_name</span><span class=p>,</span>
      <span class=n>eip</span><span class=o>-</span><span class=n>info</span><span class=p>.</span><span class=n>eip_fn_addr</span><span class=p>);</span>
<span class=c1>//         kern/monitor.c:143: monitor+106
</span><span class=c1></span>    <span class=n>ebp</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=o>*</span><span class=p>)</span> <span class=o>*</span><span class=n>ebp</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

</code></pre></td></tr></table></div>
</div>
</div><p>运行结果：</p>
<div class=highlight><div class=chroma>
<div class=table-container><table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>qemu-system-i386 -nographic -drive <span class=nv>file</span><span class=o>=</span>obj/kern/kernel.img,index<span class=o>=</span>0,media<span class=o>=</span>disk,format<span class=o>=</span>raw -serial mon:stdio -gdb tcp::26000 -D qemu.log  -S
<span class=m>6828</span> decimal is  octal!
entering test_backtrace <span class=m>5</span>
entering test_backtrace <span class=m>4</span>
entering test_backtrace <span class=m>3</span>
entering test_backtrace <span class=m>2</span>
entering test_backtrace <span class=m>1</span>
entering test_backtrace <span class=m>0</span>
Stack backtrace:
ebp f010ff18  eip f0100078  args <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> f010004a f0111308
             kern/init.c:18: test_backtrace+56
ebp f010ff38  eip f01000a1  args <span class=m>00000000</span> <span class=m>00000001</span> f010ff78 f010004a f0111308
             kern/init.c:16: test_backtrace+97
ebp f010ff58  eip f01000a1  args <span class=m>00000001</span> <span class=m>00000002</span> f010ff98 f010004a f0111308
             kern/init.c:16: test_backtrace+97
ebp f010ff78  eip f01000a1  args <span class=m>00000002</span> <span class=m>00000003</span> f010ffb8 f010004a f0111308
             kern/init.c:16: test_backtrace+97
ebp f010ff98  eip f01000a1  args <span class=m>00000003</span> <span class=m>00000004</span> <span class=m>00000000</span> f010004a f0111308
             kern/init.c:16: test_backtrace+97
ebp f010ffb8  eip f01000a1  args <span class=m>00000004</span> <span class=m>00000005</span> <span class=m>00000000</span> f010004a f0111308
             kern/init.c:16: test_backtrace+97
ebp f010ffd8  eip f01000f4  args <span class=m>00000005</span> 00001aac <span class=m>00000640</span> <span class=m>00000000</span> <span class=m>00000000</span>
             kern/init.c:39: i386_init+78
ebp f010fff8  eip f010003e  args <span class=m>00000003</span> <span class=m>00001003</span> <span class=m>00002003</span> <span class=m>00003003</span> <span class=m>00004003</span>
             kern/entry.S:83: &lt;unknown&gt;+0
leaving test_backtrace <span class=m>0</span>
leaving test_backtrace <span class=m>1</span>
leaving test_backtrace <span class=m>2</span>
leaving test_backtrace <span class=m>3</span>
leaving test_backtrace <span class=m>4</span>
leaving test_backtrace <span class=m>5</span>
Welcome to the JOS kernel monitor!
Type <span class=s1>&#39;help&#39;</span> <span class=k>for</span> a list of commands.
K&gt;

</code></pre></td></tr></table></div>
</div>
</div><p>参考链接:</p>
<p><a href=https://github.com/shishujuan/mit6.828-2017/blob/master/docs/lab1-exercize.md target=_blank rel=noopener>https://github.com/shishujuan/mit6.828-2017/blob/master/docs/lab1-exercize.md</a></p>
<p><a href=https://github.com/Clann24/jos/tree/master/lab1 target=_blank rel=noopener>https://github.com/Clann24/jos/tree/master/lab1</a></p>
</div>
</article>
<div class=related-posts>
<h2 class=related-title>相关文章：<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6.0-12-5.4-12-12v-92h-92c-6.6.0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6.0 12 5.4 12 12v92h92c6.6.0 12 5.4 12 12v56z"/></svg></h2>
<ul class=related-list>
<li class=related-item>
<a href=/archives-604/ class=related-link>MIT6.828 | Lec6: Virtual Memory - 1</a>
</li>
<li class=related-item>
<a href=/archives-602/ class=related-link>MIT6.828 | hw5: xv6 system calls 【待填坑 dup2】</a>
</li>
<li class=related-item>
<a href=/archives-601/ class=related-link>MIT6.828 | Lec 5: Isolation mechanisms</a>
</li>
<li class=related-item>
<a href=/archives-592/ class=related-link>MIT6.828 | Lec4: Shell & OS organization</a>
</li>
<li class=related-item>
<a href=/archives-579/ class=related-link>MIT6.828 | Lab 2: Memory Management</a>
</li>
</ul>
</div>
<div class=post-tags>
<a href=/tags/note/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>note</a>
<a href=/tags/mit6.828/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>MIT6.828</a>
</div>
<footer class=minimal-footer>
<div class=post-tag><a href=/tags/note/ rel=tag class=post-tag-link>#note</a> <a href=/tags/mit6.828/ rel=tag class=post-tag-link>#mit6828</a></div>
<div class=post-category>
<a href=/tech/ class="post-category-link active">tech</a>
</div>
</footer>
<ul class=post-nav>
<li class=post-nav-prev>
<a href=/archives-540/ rel=prev>&lt; MIT6.828 | Lec2: x86 and PC architecture</a>
</li>
<li class=post-nav-next>
<a href=/archives-535/ rel=next>MIT6.828 | Lab 1: Booting a PC - Part 2: The Boot Loader ></a>
</li>
</ul>
</div>
</main>
<div id=back-to-top class=back-to-top>
<a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
</div>
<footer id=footer class=footer>
<div class=footer-inner>
<div class=site-info>©&nbsp;2019–2021&nbsp;&nbsp;Jiachen</div><div class=site-copyright><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a></div>
</div>
</footer>
</div>
<script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script>
<script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script>
<script>mediumZoom(document.querySelectorAll('div.post-body img'),{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script>
<script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script>
</body>
</html>